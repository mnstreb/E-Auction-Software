<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proquotely - Construction Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Component & Section CSS -->
    <link rel="stylesheet" href="src/components/AppHeader/AppHeader.css">
    <link rel="stylesheet" href="src/components/SaveProjectModal/SaveProjectModal.css">
    <link rel="stylesheet" href="src/components/CompanyProfile/CompanyProfile.css">
    <link rel="stylesheet" href="src/sections/SummaryOverview/SummaryOverview.css">
    <link rel="stylesheet" href="src/sections/SetupWizard/SetupWizard.css">
    <link rel="stylesheet" href="src/sections/SavedProjects/SavedProjects.css">
    <link rel="stylesheet" href="src/sections/QuickQuoteSummary/QuickQuoteSummary.css">

    <style>
        /* Base styles and UI improvements */
        body {
            margin: 0;
            font-family: 'Inter var', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%);
            min-height: 100vh;
            color: #374151;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .input-field {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            font-size: 15px;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background: #1D4ED8;
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
            transform: translateY(-1px);
        }
        .btn-green {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover {
            background: #059669;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }
        .btn-red {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        .btn-red:hover {
            background: #dc2626;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
        .btn-orange {
            background: #f97316;
            color: white;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.2);
        }
        .btn-orange:hover {
            background: #ea580c;
            box-shadow: 0 6px 20px rgba(234, 88, 12, 0.3);
            transform: translateY(-1px);
        }

        .entry-point-logo {
            max-width: 300px;
            margin: 0 auto 20px;
        }

        .entry-point-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 2000;
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%);
        }
        .entry-point-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .entry-point-content h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .entry-point-content p {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 40px;
        }
        .entry-point-buttons {
            display: flex;
            gap: 20px;
        }
        .entry-point-buttons .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }


        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            transition: border-color 0.3s;
            vertical-align: middle;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #4b5563;
            position: sticky;
            top: 0;
            z-index: 1;
            transition: background-color 0.3s, color 0.3s;
        }
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }

        tr:nth-child(even) {
            background: #f8fafc;
            transition: background-color 0.3s;
        }
        tr:hover {
            background: #e0f2fe;
            transition: background 0.15s ease-in-out;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        .label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4b5563;
            font-size: 15px;
            transition: color 0.3s;
        }
        h1, h2, h3 {
            color: #1f2937;
            transition: color 0.3s;
        }
        h1 { font-size: 32px; margin-bottom: 15px !important; }
        h2 { font-size: 26px; margin-bottom: 25px !important; }
        h3 { font-size: 22px; margin-bottom: 20px !important; }

        /* AI Chat Styles */
        .ai-chat-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: #2563eb;
            color: white;
            width: 60px; 
            height: 60px;
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; 
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999;
        }
        .ai-chat-button:hover {
            background-color: #1D4ED8;
            transform: translateY(-2px);
        }
        .ai-chat-modal {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 400px;
            height: 500px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .ai-chat-modal.show {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }
        .ai-chat-header {
            padding: 15px;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-chat-header h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        .ai-chat-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        .ai-chat-history {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }
        .chat-bubble.user {
            background-color: #2563eb;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.ai {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble.loading {
            align-self: flex-start;
            color: #6b7280;
        }
        .ai-chat-input-area {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        .ai-chat-input-area input {
            flex-grow: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 8px; overflow: hidden; transition: border-color 0.3s; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; font-size: 14px; }
            td:before { content: attr(data-label); position: absolute; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #4b5563; transition: color 0.3s; }
            td:nth-of-type(1):before { content: "Task Name:"; }
            td:nth-of-type(2):before { content: "Description:"; }
            td:nth-of-type(3):before { content: "OT/DT Multiplier:"; }
            td:nth-of-type(4):before { content: "Trade:"; }
            td:nth-of-type(5):before { content: "Skill:"; }
            td:nth-of-type(6):before { content: "Rate:"; }
            td:nth-of-type(7):before { content: "# hrs:"; }
            td:nth-of-type(8):before { content: "Labor Total:"; }
            td:nth-of-type(9):before { content: "QTY / UNIT:"; }
            td:nth-of-type(10):before { content: "$ / UNIT:"; }
            td:nth-of-type(11):before { content: "Materials Total:"; }
            td:nth-of-type(12):before { content: "Equipment / Rental:"; }
            td:nth-of-type(13):before { content: "Subcontractor:"; }
            td:nth-of-type(14):before { content: "Misc.:"; }
            td:nth-of-type(15):before { content: "Other Total:"; }
            td:nth-of-type(16):before { content: "TOTAL:"; }
            td:nth-of-type(17):before { content: "Actions:"; }
        }

        /* Hide spinner arrows for number input fields */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .collapsible-header { display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; user-select: none; padding: 0; height: 100%; width: 100%; }
        .collapse-toggle-icon { font-size: 0.8em; transition: transform 0.2s ease-in-out; display: inline-block; }
        .collapsible-header.collapsed .collapse-toggle-icon { transform: rotate(-90deg); }
        .column-hidden { display: none !important; }

        /* Dark Theme Styles */
        body.dark-theme { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); color: #e2e8f0; }
        .dark-theme .card { background: #2d3748; box-shadow: 0 6px 25px rgba(0,0,0,0.4); }
        .dark-theme .input-field { background-color: #4a5568; border-color: #4a5568; color: #e2e8f0; }
        .dark-theme .input-field:focus { border-color: #63b3ed; box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3); }
        .dark-theme .label, .dark-theme h1, .dark-theme h2, .dark-theme h3 { color: #e2e8f0; }
        .dark-theme table, .dark-theme th, .dark-theme td { border-color: #4a5568; }
        .dark-theme th { background: #4a5568; color: #e2e8f0; }
        .dark-theme tr:nth-child(even) { background: #2d3748; }
        .dark-theme tr:hover { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Entry Point Screen -->
    <div id="entryPointContainer" class="entry-point-container">
        <div class="entry-point-content">
            <img src="Assets/Proquotelyasset-25.png" alt="Proquotely Logo" class="entry-point-logo">
            <h1>Construction Estimator Pro</h1>
            <p>Choose how you'd like to begin.</p>
            <div class="entry-point-buttons">
                <button id="startDetailedBtn" class="btn btn-primary">Start Detailed Estimate</button>
                <button id="startQuickQuoteBtn" class="btn btn-green">Generate Quick Quote</button>
            </div>
        </div>
    </div>

    <!-- Shared Header Container -->
    <div class="container" id="appHeaderContainer">
        <div id="appHeaderPlaceholder"></div>
    </div>

    <!-- Main Detailed Estimate App -->
    <div id="mainApp" class="container hidden">
        <div id="summaryOverviewPlaceholder"></div>
        <div class="card overflow-x-auto" id="estimateLineItemsTableContainer">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Estimate Line Items</h3>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label for="defaultTradeSelector" class="label mb-0">Default Trade:</label>
                        <select id="defaultTradeSelector" class="input-field w-48"></select>
                    </div>
                    <button id="addItemBtn" class="btn btn-green">➕ Add Item</button>
                </div>
            </div>
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th rowspan="2">Task Name</th>
                        <th rowspan="2">Description</th>
                        <th colspan="5" class="text-center" id="thLaborHeader">
                            <div class="collapsible-header" data-group="labor"><span>LABOR</span><span class="collapse-toggle-icon">▼</span></div>
                        </th>
                        <th colspan="3" class="text-center" id="thMaterialsHeader">
                            <div class="collapsible-header" data-group="materials"><span>MATERIALS</span><span class="collapse-toggle-icon">▼</span></div>
                        </th>
                        <th colspan="4" class="text-center" id="thOtherHeader">
                            <div class="collapsible-header" data-group="other"><span>OTHER</span><span class="collapse-toggle-icon">▼</span></div>
                        </th>
                        <th rowspan="2">TOTAL</th>
                        <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                        <th data-col-group="labor-details">OT/DT</th>
                        <th data-col-group="labor-details">Trade</th>
                        <th data-col-group="labor-details">Skill</th>
                        <th data-col-group="labor-details">$/hr</th>
                        <th data-col-group="labor-details">Labor Total</th>
                        <th data-col-group="materials-details">QTY/UNIT</th>
                        <th data-col-group="materials-details">$/UNIT</th>
                        <th data-col-group="materials-details">Materials Total</th>
                        <th data-col-group="other-details">Equipment</th>
                        <th data-col-group="other-details">Sub</th>
                        <th data-col-group="other-details">Misc.</th>
                        <th data-col-group="other-details">Other Total</th>
                    </tr>
                </thead>
                <tbody id="estimateTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Quote App -->
    <div id="quickQuoteApp" class="container hidden">
        <div id="quickQuoteSummaryPlaceholder"></div>
    </div>

    <!-- Component Placeholders -->
    <div id="setupWizardPlaceholder"></div>
    <div id="savedProjectsPlaceholder"></div>
    <div id="companyProfilePlaceholder"></div>

    <!-- Save Project Modal -->
    <div id="saveProjectModal" class="save-project-modal">
        <div class="save-project-modal-content">
            <h3>Save Project</h3>
            <div class="form-group">
                <label for="saveProjectName" class="label">Project Name:</label>
                <input type="text" id="saveProjectName" class="input-field" required>
            </div>
            <div class="form-group">
                <label for="saveCustomerName" class="label">Customer Name:</label>
                <input type="text" id="saveCustomerName" class="input-field" required>
            </div>
            <div class="form-group">
                <label for="saveLocation" class="label">Location (State):</label>
                <input type="text" id="saveLocation" class="input-field" required>
            </div>
            <div class="form-group">
                <label for="saveProjectCost" class="label">Total Project Cost:</label>
                <input type="text" id="saveProjectCost" class="input-field" readonly>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancelSaveProjectBtn" class="btn btn-red">Cancel</button>
                <button id="confirmSaveProjectBtn" class="btn btn-green">Save</button>
            </div>
        </div>
    </div>

    <!-- AI Chat Assistant -->
    <button id="aiChatButton" class="ai-chat-button">AI</button>
    <div id="aiChatModal" class="ai-chat-modal">
        <div class="ai-chat-header">
            <h4>AI Estimating Assistant</h4>
            <button id="aiChatCloseBtn" class="ai-chat-close-btn">&times;</button>
        </div>
        <div id="aiChatHistory" class="ai-chat-history">
             <div class="chat-bubble ai">Hello! How can I help you with your estimate today?</div>
        </div>
        <div class="ai-chat-input-area">
            <input type="text" id="aiChatInput" class="input-field" placeholder="Ask a question...">
            <button id="aiChatSendBtn" class="btn btn-primary">Send</button>
        </div>
    </div>

    <script type="module"> 
        // Import component modules
        import QuickQuoteSummary from './src/sections/QuickQuoteSummary/QuickQuoteSummary.js';
        import { exportClientQuoteToPdf, exportDetailedReportToPdf, exportEstimateToCsv } from './src/services/exportService.js';
        
        const PERMANENT_DEFAULT_LOGO = "Assets/Proquotelyasset-25.png";

        // --- Core Application Functions ---
        async function loadAppHeader() {
            try {
                const response = await fetch('src/components/AppHeader/AppHeader.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('appHeaderPlaceholder').innerHTML = await response.text();

                const script = document.createElement('script');
                script.src = 'src/components/AppHeader/AppHeader.js';
                script.onload = () => {
                    if (window.AppHeader) {
                        window.AppHeader.init({
                            mainAppLogoId: 'mainAppLogo',
                            reconfigureBtnId: 'reconfigureBtn',
                            saveProjectBtnId: 'saveProjectBtn',
                            exportDropdownBtnId: 'exportDropdownBtn',
                            exportDropdownMenuId: 'exportDropdownMenu',
                            userProfileBtnId: 'userProfileBtn',
                            userProfileDropdownMenuId: 'userProfileDropdownMenu', 
                            profileDropdownThemeToggleId: 'profileDropdownThemeToggle', 
                            savedProjectsMenuItemId: 'savedProjectsMenuItem', 
                            companyProfileMenuItemId: 'companyProfileMenuItem',
                            exportPdfReportBtnId: 'exportPdfReportBtn',
                            exportCsvBtnId: 'exportCsvBtn',
                            exportPdfQuoteBtnId: 'exportPdfQuoteBtn',
                            emailClientBtnId: 'emailClientBtn',
                            onThemeToggle: toggleTheme,
                            onReconfigure: reconfigureApp, 
                            onSaveProject: handleSaveProject,
                            onExportPdfReport: () => { calculateTotals(); exportDetailedReportToPdf(projectSettings, estimateItems, formatCurrency, formatHours, renderMessageBox); },
                            onExportCsv: () => { calculateTotals(); exportEstimateToCsv(projectSettings, estimateItems, renderMessageBox); },
                            onExportPdfQuote: () => { calculateTotals(); exportClientQuoteToPdf(projectSettings, estimateItems, currentAppMode, formatCurrency, renderMessageBox); },
                            onEmailClient: sendEstimateEmailToClient,
                            onUserProfileClick: showSavedProjects,
                            onCompanyProfileClick: showCompanyProfile
                        });
                        if (window.AppHeader.updateThemeToggleSlider) {
                            window.AppHeader.updateThemeToggleSlider(isDarkTheme);
                        }
                    }
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error loading AppHeader component:", error);
            }
        }

        async function loadCompanyProfile() {
            try {
                const response = await fetch('src/components/CompanyProfile/CompanyProfile.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('companyProfilePlaceholder').innerHTML = await response.text();

                const script = document.createElement('script');
                script.src = 'src/components/CompanyProfile/CompanyProfile.js';
                script.onload = () => {
                    if (window.CompanyProfile) {
                        window.CompanyProfile.init({
                            onSave: handleCompanyProfileSave
                        });
                    }
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error loading CompanyProfile component:", error);
            }
        }

        async function loadSummaryOverview() {
            try {
                const response = await fetch('src/sections/SummaryOverview/SummaryOverview.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('summaryOverviewPlaceholder').innerHTML = await response.text();
                const script = document.createElement('script');
                script.src = 'src/sections/SummaryOverview/SummaryOverview.js';
                script.onload = () => {
                    if (window.SummaryOverview) {
                        window.SummaryOverview.init({ projectSettings, estimateItems, formatCurrency, formatHours, isDarkTheme });
                    }
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error loading SummaryOverview component:", error);
            }
        }

        async function loadQuickQuoteSummary() {
            try {
                const response = await fetch('src/sections/QuickQuoteSummary/QuickQuoteSummary.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('quickQuoteSummaryPlaceholder').innerHTML = await response.text();
                if (QuickQuoteSummary) {
                    QuickQuoteSummary.init({ projectSettings, formatCurrency, formatHours, isDarkTheme });
                }
            } catch (error) {
                console.error("Error loading QuickQuoteSummary component:", error);
            }
        }

        async function loadSetupWizard() {
            try {
                const response = await fetch('src/sections/SetupWizard/SetupWizard.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('setupWizardPlaceholder').innerHTML = await response.text();
                document.getElementById('setupWizardPlaceholder').classList.remove('hidden');
                const script = document.createElement('script');
                script.src = 'src/sections/SetupWizard/SetupWizard.js';
                script.onload = () => {
                    if (window.SetupWizard) {
                        window.SetupWizard.init({
                            projectSettings, estimateItems, stateSalesTax,
                            onCompletion: handleWizardCompletion,
                            renderMessageBox, closeMessageBox,
                            mode: currentAppMode 
                        });
                        window.SetupWizard.showStep(1);
                    }
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error loading SetupWizard component:", error);
            }
        }

        async function loadSavedProjects() {
            try {
                const response = await fetch('src/sections/SavedProjects/SavedProjects.html');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('savedProjectsPlaceholder').innerHTML = await response.text();
                const script = document.createElement('script');
                script.src = 'src/sections/SavedProjects/SavedProjects.js';
                script.onload = () => {
                    if (window.SavedProjects) {
                        window.SavedProjects.init({
                            onGoToCalculator: showMainApp,
                            formatCurrency, isDarkTheme,
                            renderMessageBox, closeMessageBox
                        });
                        document.getElementById('savedProjectsPlaceholder').classList.remove('hidden');
                    }
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error loading SavedProjects component:", error);
            }
        }

        function showCompanyProfile() {
            if (window.CompanyProfile) {
                const companyData = {
                    ownerName: projectSettings.ownerName,
                    ownerAddress: projectSettings.ownerAddress,
                    ownerCity: projectSettings.ownerCity,
                    ownerZip: projectSettings.ownerZip,
                    ownerEmail: projectSettings.ownerEmail
                };
                window.CompanyProfile.show(companyData);
            }
        }

        function handleCompanyProfileSave(companyData) {
            Object.assign(projectSettings, companyData);
            renderMessageBox('Company information updated successfully!');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function formatHours(hours) {
            return parseFloat(hours).toFixed(2);
        }

        const initialProjectSettings = {
            projectName: "New Project", clientName: "", projectAddress: "", projectCity: "",
            ownerName: "Proquotely Inc.", ownerAddress: "123 Builder Lane", ownerCity: "Constructville", ownerZip: "54321", ownerEmail: "contact@proquotely.com",
            projectZip: "", startDate: "", endDate: "", projectID: "", projectDescription: "",
            contractorLogo: "", projectType: "Commercial", projectState: "CA",
            profitMargin: 15, salesTax: 8.25, miscellaneous: 5, overhead: 10, materialMarkup: 10, 
            discount: 0, additionalConsiderationsType: '%', additionalConsiderationsValue: 0,
            allTradeLaborRates: {
                "General": { "Project Manager": 120, "Superintendent": 100, "General Foreman": 90, "Foreman": 85, "Journeyman": 75, "Apprentice": 50 },
                "Electrical": { "Project Manager": 135, "Superintendent": 110, "General Foreman": 100, "Foreman": 95, "Journeyman": 80, "Apprentice": 55 },
                "Plumbing": { "Project Manager": 125, "Superintendent": 105, "General Foreman": 95, "Foreman": 90, "Journeyman": 78, "Apprentice": 52 },
                "HVAC": { "Project Manager": 130, "Superintendent": 108, "General Foreman": 98, "Foreman": 92, "Journeyman": 77, "Apprentice": 53 },
                "Carpentry": { "Project Manager": 115, "Superintendent": 95, "General Foreman": 85, "Foreman": 80, "Journeyman": 70, "Apprentice": 48 },
                "Concrete": { "Project Manager": 110, "Superintendent": 90, "General Foreman": 80, "Foreman": 75, "Journeyman": 68, "Apprentice": 45 },
                "Roofing": { "Project Manager": 120, "Superintendent": 98, "General Foreman": 88, "Foreman": 83, "Journeyman": 73, "Apprentice": 47 },
                "Painting": { "Project Manager": 105, "Superintendent": 88, "General Foreman": 78, "Foreman": 73, "Journeyman": 65, "Apprentice": 42 },
                "Drywall": { "Project Manager": 112, "Superintendent": 92, "General Foreman": 82, "Foreman": 77, "Journeyman": 69, "Apprentice": 44 },
                "Masonry": { "Project Manager": 128, "Superintendent": 102, "General Foreman": 93, "Foreman": 88, "Journeyman": 76, "Apprentice": 51 },
                "Landscaping": { "Project Manager": 100, "Superintendent": 85, "General Foreman": 75, "Foreman": 70, "Journeyman": 60, "Apprentice": 40 }
            },
            activeTrades: ["General"],
        };

        const initialEstimateItems = [{
            id: Date.now(), taskName: 'First Task', description: 'Detail your first project task here.',
            trade: 'General', rateRole: 'Journeyman', hours: 0, otDtMultiplier: 1.0,
            materialQuantity: 0, materialUnitCost: 0, equipmentRentalCost: 0,
            subcontractorCostLineItem: 0, miscLineItem: 0
        }];
        
        const stateSalesTax = {
            'CA': 8.25, 'TX': 6.25, 'NY': 4.0, 'FL': 6.0, 'WA': 6.5, 'IL': 6.25, 'AL': 4.0, 'AK': 0.0, 'AZ': 5.6, 'AR': 6.5, 'CO': 2.9, 'CT': 6.35, 'DE': 0.0, 'GA': 4.0, 'HI': 4.0, 'ID': 6.0, 'IN': 7.0, 'IA': 6.0, 'KS': 6.5, 'KY': 6.0, 'LA': 4.45, 'ME': 5.5, 'MD': 6.0, 'MA': 6.25, 'MI': 6.0, 'MN': 6.875, 'MS': 7.0, 'MO': 4.225, 'MT': 0.0, 'NE': 5.5, 'NV': 6.85, 'NH': 0.0, 'NJ': 6.625, 'NM': 5.125, 'NC': 4.75, 'ND': 5.0, 'OH': 5.75, 'OK': 4.5, 'OR': 0.0, 'PA': 6.0, 'RI': 7.0, 'SC': 6.0, 'SD': 4.5, 'TN': 7.0, 'UT': 4.85, 'VT': 6.0, 'VA': 5.3, 'WV': 6.0, 'WI': 5.0, 'WY': 4.0
        };

        let projectSettings = {};
        let estimateItems = [];
        let currentAppMode = 'entry';
        let isDarkTheme = false;

        document.addEventListener('DOMContentLoaded', () => {
            resetProjectState(); 
            loadAppHeader(); 
            loadCompanyProfile();
            setupInitialEventListeners();
        });

        function resetProjectState() {
             projectSettings = JSON.parse(JSON.stringify(initialProjectSettings));
             estimateItems = JSON.parse(JSON.stringify(initialEstimateItems));
        }

        function setupInitialEventListeners() {
            document.getElementById('startDetailedBtn').addEventListener('click', startDetailedEstimate);
            document.getElementById('startQuickQuoteBtn').addEventListener('click', startQuickQuote);
            document.getElementById('addItemBtn')?.addEventListener('click', addItem);
            document.getElementById('estimateTableBody')?.addEventListener('change', handleTableChange);
            document.getElementById('estimateTableBody')?.addEventListener('click', handleTableClick);
            document.getElementById('cancelSaveProjectBtn')?.addEventListener('click', () => document.getElementById('saveProjectModal').classList.remove('show'));
            document.getElementById('confirmSaveProjectBtn')?.addEventListener('click', confirmSaveProject);
            document.getElementById('aiChatButton')?.addEventListener('click', () => document.getElementById('aiChatModal').classList.toggle('show'));
            document.getElementById('aiChatCloseBtn')?.addEventListener('click', () => document.getElementById('aiChatModal').classList.remove('show'));
            document.getElementById('aiChatSendBtn')?.addEventListener('click', () => handleAIChatSend(false));
            document.getElementById('aiChatInput')?.addEventListener('keypress', (e) => e.key === 'Enter' && handleAIChatSend(false));
        }
        
        function handleTableChange(event) {
            const target = event.target;
            const row = target.closest('tr[data-id]');
            if (!row) return;
            const itemId = parseInt(row.dataset.id, 10);
            const field = target.dataset.field;
            if (itemId && field) {
                updateItem(itemId, field, target.value);
            }
        }

        function handleTableClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;
            const itemId = parseInt(button.dataset.itemId, 10);
            const action = button.dataset.action;
            if (itemId && action === 'delete') {
                deleteItem(itemId);
            } else if (itemId && action === 'duplicate') {
                duplicateItem(itemId);
            }
        }
        
        function handleWizardCompletion(updatedSettings) {
            projectSettings = { ...updatedSettings };
            if (currentAppMode === 'detailed' && !projectSettings.contractorLogo) {
                projectSettings.contractorLogo = PERMANENT_DEFAULT_LOGO;
            }
            document.getElementById('setupWizardPlaceholder').classList.add('hidden');
            document.getElementById('entryPointContainer').classList.add('hidden');
            
            if (projectSettings.projectType === "Quick Quote") {
                 document.getElementById('quickQuoteApp').classList.remove('hidden');
                 loadQuickQuoteSummary();
            } else {
                 document.getElementById('mainApp').classList.remove('hidden');
                 loadSummaryOverview();
            }
            
            if (window.AppHeader) {
                window.AppHeader.updateProjectInfo(projectSettings.projectType, projectSettings.projectName, projectSettings.clientName, projectSettings.projectState);
                window.AppHeader.updateLogo(projectSettings.contractorLogo);
            }
            renderItems();
        }

        function reconfigureApp() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('quickQuoteApp').classList.add('hidden');
            loadSetupWizard();
        }

        function startDetailedEstimate() {
            currentAppMode = 'detailed';
            resetProjectState();
            projectSettings.contractorLogo = PERMANENT_DEFAULT_LOGO;
            document.getElementById('entryPointContainer').classList.add('hidden');
            loadSetupWizard();
        }

        function startQuickQuote() {
            currentAppMode = 'quickQuote';
            resetProjectState();
            projectSettings.projectType = "Quick Quote";
            document.getElementById('entryPointContainer').classList.add('hidden');
            document.getElementById('quickQuoteApp').classList.remove('hidden');
            loadQuickQuoteSummary();
            if (window.AppHeader) {
                window.AppHeader.updateProjectInfo('Quick Quote', 'New Quick Quote', '', 'N/A'); 
                window.AppHeader.updateLogo(''); 
            }
        }

        function showMainApp() {
            currentAppMode = 'detailed';
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('quickQuoteApp').classList.add('hidden');
            document.getElementById('savedProjectsPlaceholder').classList.add('hidden');
            if (window.AppHeader) {
                window.AppHeader.updateProjectInfo(projectSettings.projectType, projectSettings.projectName, projectSettings.clientName, projectSettings.projectState);
                window.AppHeader.updateLogo(projectSettings.contractorLogo);
            }
            calculateTotals();
        }
        
        function handleSaveProject() {
            calculateTotals();
            document.getElementById('saveProjectName').value = projectSettings.projectName || '';
            document.getElementById('saveCustomerName').value = projectSettings.clientName || '';
            document.getElementById('saveLocation').value = projectSettings.projectState || ''; 
            document.getElementById('saveProjectCost').value = formatCurrency(projectSettings.grandTotal || 0);
            document.getElementById('saveProjectModal').classList.add('show');
        }

        function confirmSaveProject() {
            const newSavedProject = {
                id: `proj_${Date.now()}`,
                projectName: document.getElementById('saveProjectName').value.trim(),
                customerName: document.getElementById('saveCustomerName').value.trim(),
                projectType: projectSettings.projectType,
                projectState: document.getElementById('saveLocation').value.trim(),
                totalProposal: projectSettings.grandTotal || 0,
                lastSavedDate: new Date().toISOString().split('T')[0],
                status: 'Draft',
                projectDetails: JSON.stringify({ settings: projectSettings, items: estimateItems })
            };
            if (window.SavedProjects) {
                window.SavedProjects.addProject(newSavedProject);
                renderMessageBox(`Project "${newSavedProject.projectName}" saved successfully!`);
            }
            document.getElementById('saveProjectModal').classList.remove('show');
        }

        function showSavedProjects() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('quickQuoteApp').classList.add('hidden');
            const placeholder = document.getElementById('savedProjectsPlaceholder');
            if (placeholder.innerHTML === '') {
                loadSavedProjects();
            } else {
                placeholder.classList.remove('hidden');
                if (window.SavedProjects) {
                     window.SavedProjects.renderProjects(window.SavedProjects.getSavedProjectsData());
                     window.SavedProjects.updateCustomerTotalsChart(window.SavedProjects.getSavedProjectsData(), isDarkTheme);
                }
            }
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('dark-theme', isDarkTheme);
            if (window.AppHeader) {
                window.AppHeader.updateThemeToggleSlider(isDarkTheme);
            }
            if (window.SummaryOverview) {
                window.SummaryOverview.updateSummaries(projectSettings, estimateItems, isDarkTheme);
            }
            if (window.SavedProjects) {
                window.SavedProjects.updateCustomerTotalsChart(window.SavedProjects.getSavedProjectsData(), isDarkTheme);
            }
        }
        
        function addItem() {
            const newItem = {
                id: Date.now(), taskName: 'New Task', description: '',
                trade: 'General', rateRole: 'Journeyman', hours: 0, otDtMultiplier: 1.0,
                materialQuantity: 0, materialUnitCost: 0, equipmentRentalCost: 0,
                subcontractorCostLineItem: 0, miscLineItem: 0
            };
            estimateItems.push(newItem);
            renderItems();
        }

        function deleteItem(id) {
            estimateItems = estimateItems.filter(item => item.id !== id);
            renderItems();
        }
        
        function duplicateItem(id) {
            const itemIndex = estimateItems.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                const duplicatedItem = JSON.parse(JSON.stringify(estimateItems[itemIndex]));
                duplicatedItem.id = Date.now();
                estimateItems.splice(itemIndex + 1, 0, duplicatedItem);
                renderItems();
            }
        }

        function updateItem(id, field, value) {
            const item = estimateItems.find(item => item.id === id);
            if (item) {
                if (['hours', 'materialQuantity', 'materialUnitCost', 'equipmentRentalCost', 'subcontractorCostLineItem', 'miscLineItem', 'otDtMultiplier'].includes(field)) {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                if (field === 'trade') {
                    const availableRoles = Object.keys(projectSettings.allTradeLaborRates[item.trade] || {});
                    item.rateRole = availableRoles.length > 0 ? availableRoles[0] : "Journeyman";
                }
                renderItems();
            }
        }
        
        function renderItems() {
            const tableBody = document.getElementById('estimateTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            estimateItems.forEach(item => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const laborTotal = item.hours * laborRate * (item.otDtMultiplier || 1.0);
                const materialsTotal = item.materialQuantity * item.materialUnitCost;
                const otherTotal = item.equipmentRentalCost + item.subcontractorCostLineItem + item.miscLineItem;
                const lineTotal = laborTotal + materialsTotal + otherTotal;

                const row = document.createElement('tr');
                row.dataset.id = item.id;
                row.innerHTML = `
                    <td data-label="Task Name"><textarea data-field="taskName" class="input-field">${item.taskName}</textarea></td>
                    <td data-label="Description"><textarea data-field="description" class="input-field">${item.description}</textarea></td>
                    <td data-label="OT/DT"><select data-field="otDtMultiplier" class="input-field"><option value="1.0" ${item.otDtMultiplier === 1.0 ? 'selected' : ''}>1.0</option><option value="1.5" ${item.otDtMultiplier === 1.5 ? 'selected' : ''}>1.5</option><option value="2.0" ${item.otDtMultiplier === 2.0 ? 'selected' : ''}>2.0</option></select></td>
                    <td data-label="Trade"><select data-field="trade" class="input-field">${Object.keys(projectSettings.allTradeLaborRates).map(t => `<option value="${t}" ${item.trade === t ? 'selected' : ''}>${t}</option>`).join('')}</select></td>
                    <td data-label="Skill"><select data-field="rateRole" class="input-field">${Object.keys(projectSettings.allTradeLaborRates[item.trade] || {}).map(r => `<option value="${r}" ${item.rateRole === r ? 'selected' : ''}>${r}</option>`).join('')}</select></td>
                    <td data-label="$/hr">${formatCurrency(laborRate)}</td>
                    <td data-label="Labor Total">${formatCurrency(laborTotal)}</td>
                    <td data-label="QTY/UNIT"><input type="number" data-field="materialQuantity" value="${item.materialQuantity}" class="input-field"></td>
                    <td data-label="$/UNIT"><input type="number" data-field="materialUnitCost" value="${item.materialUnitCost}" class="input-field"></td>
                    <td data-label="Materials Total">${formatCurrency(materialsTotal)}</td>
                    <td data-label="Equipment"><input type="number" data-field="equipmentRentalCost" value="${item.equipmentRentalCost}" class="input-field"></td>
                    <td data-label="Sub"><input type="number" data-field="subcontractorCostLineItem" value="${item.subcontractorCostLineItem}" class="input-field"></td>
                    <td data-label="Misc."><input type="number" data-field="miscLineItem" value="${item.miscLineItem}" class="input-field"></td>
                    <td data-label="Other Total">${formatCurrency(otherTotal)}</td>
                    <td data-label="TOTAL">${formatCurrency(lineTotal)}</td>
                    <td data-label="Actions"><button class="btn btn-orange btn-sm" data-action="duplicate" data-item-id="${item.id}">D</button><button class="btn btn-red btn-sm" data-action="delete" data-item-id="${item.id}">X</button></td>
                `;
                tableBody.appendChild(row);
            });
            calculateTotals();
        }

        function calculateTotals() {
            let totalLaborCost = 0, totalMaterialCostRaw = 0, totalEquipmentCost = 0, totalSubcontractorCost = 0, totalMiscLineItemCosts = 0;
            estimateItems.forEach(item => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                totalLaborCost += item.hours * laborRate * (item.otDtMultiplier || 1.0);
                totalMaterialCostRaw += item.materialQuantity * item.materialUnitCost;
                totalEquipmentCost += item.equipmentRentalCost;
                totalSubcontractorCost += item.subcontractorCostLineItem;
                totalMiscLineItemCosts += item.miscLineItem;
            });
            
            const totalProjectCostDirect = totalLaborCost + totalMaterialCostRaw + totalEquipmentCost + totalSubcontractorCost + totalMiscLineItemCosts;
            const materialMarkupAmount = totalMaterialCostRaw * (projectSettings.materialMarkup / 100);
            const baseCostForMarkups = totalProjectCostDirect + materialMarkupAmount;
            const totalOverheadCost = baseCostForMarkups * (projectSettings.overhead / 100);
            const totalMiscCostAmount = baseCostForMarkups * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfit = baseCostForMarkups + totalOverheadCost + totalMiscCostAmount;
            const totalProfitMarginAmount = subtotalBeforeProfit * (projectSettings.profitMargin / 100);
            const estimateSubtotal = subtotalBeforeProfit + totalProfitMarginAmount;
            const salesTaxAmount = (totalMaterialCostRaw + materialMarkupAmount) * (projectSettings.salesTax / 100);
            const additionalConsiderationAmount = projectSettings.additionalConsiderationsType === '%' ? estimateSubtotal * (projectSettings.additionalConsiderationsValue / 100) : projectSettings.additionalConsiderationsValue;
            const grandTotal = estimateSubtotal + salesTaxAmount + additionalConsiderationAmount;

            projectSettings.grandTotal = grandTotal;
            if (window.SummaryOverview) {
                window.SummaryOverview.updateSummaries(projectSettings, estimateItems, isDarkTheme);
            }
        }

        function sendEstimateEmailToClient() {
            calculateTotals();
            const subject = `Estimate for ${projectSettings.projectName}`;
            const body = `Dear ${projectSettings.clientName},\n\nPlease find the estimate for your project attached.\n\nTotal: ${formatCurrency(projectSettings.grandTotal)}\n\nRegards,\n${projectSettings.ownerName}`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        async function handleAIChatSend(isRetry = false) {
            // AI Chat logic would go here
        }

        function renderMessageBox(message, onConfirmCallback = null, isConfirm = false) {
            const existingOverlay = document.getElementById('messageBoxOverlay');
            if (existingOverlay) existingOverlay.remove();

            const overlay = document.createElement('div');
            overlay.id = 'messageBoxOverlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[1001]';
            
            const box = document.createElement('div');
            box.className = 'bg-white rounded-xl p-8 shadow-2xl max-w-sm mx-auto text-center';
            
            box.innerHTML = `<p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>`;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-center gap-3';

            if (isConfirm) {
                const yesBtn = document.createElement('button');
                yesBtn.className = 'btn btn-red';
                yesBtn.textContent = 'Yes';
                yesBtn.onclick = () => {
                    if (onConfirmCallback) onConfirmCallback();
                    closeMessageBox();
                };
                buttonContainer.appendChild(yesBtn);

                const noBtn = document.createElement('button');
                noBtn.className = 'btn btn-primary';
                noBtn.textContent = 'No';
                noBtn.onclick = closeMessageBox;
                buttonContainer.appendChild(noBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn btn-primary';
                okBtn.textContent = 'OK';
                okBtn.onclick = closeMessageBox;
                buttonContainer.appendChild(okBtn);
            }
            box.appendChild(buttonContainer);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        function closeMessageBox() {
            const overlay = document.getElementById('messageBoxOverlay');
            if (overlay) overlay.remove();
        }

    </script>
</body>
</html>
