<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimate Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="src/components/AppHeader/AppHeader.css">
    <link rel="stylesheet" href="src/sections/SummaryOverview/SummaryOverview.css">
    <link rel="stylesheet" href="src/sections/SetupWizard/SetupWizard.css">
    <link rel="stylesheet" href="src/sections/SavedProjects/SavedProjects.css">
    <link rel="stylesheet" href="src/components/SaveProjectModal/SaveProjectModal.css"> 
    <link rel="stylesheet" href="src/sections/QuickQuoteSummary/QuickQuoteSummary.css">
    <style>
        /* Base styles and UI improvements (General styles remain here) */
        body {
            margin: 0;
            font-family: 'Inter var', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%);
            min-height: 100vh;
            color: #374151;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .input-field {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            font-size: 15px;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background: #1D4ED8;
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
            transform: translateY(-1px);
        }
        .btn-green {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover {
            background: #059669;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }
        .btn-red {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        .btn-red:hover {
            background: #dc2626;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
        .btn-orange { /* NEW: Style for the orange button */
            background: #f97316;
            color: white;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.2);
        }
        .btn-orange:hover {
            background: #ea580c;
            box-shadow: 0 6px 20px rgba(234, 88, 12, 0.3);
            transform: translateY(-1px);
        }

        /* Entry Point Screen Styles */
        .entry-point-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 2000;
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%);
        }
        .entry-point-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .entry-point-content h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .entry-point-content p {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 40px;
        }
        .entry-point-buttons {
            display: flex;
            gap: 20px;
        }
        .entry-point-buttons .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }


        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            transition: border-color 0.3s;
            vertical-align: middle; /* Essential for aligning td content */
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #4b5563;
            position: sticky;
            top: 0;
            z-index: 1;
            transition: background-color 0.3s, color 0.3s;
        }
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }

        tr:nth-child(even) {
            background: #f8fafc;
            transition: background-color 0.3s;
        }
        tr:hover {
            background: #e0f2fe;
            transition: background 0.15s ease-in-out;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        .label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4b5563;
            font-size: 15px;
            transition: color 0.3s;
        }
        h1 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 15px !important;
            transition: color 0.3s;
        }
        h2 {
            font-size: 26px;
            color: #1f2937;
            margin-bottom: 25px !important;
            transition: color 0.3s;
        }
        h3 {
            font-size: 22px;
            color: #1f2937; /* Default light theme color */
            margin-bottom: 20px !important;
            transition: color 0.3s;
        }

        /* AI Chat Styles */
        .ai-chat-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: #2563eb;
            color: white;
            width: 60px; 
            height: 60px;
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; 
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999;
        }
        .ai-chat-button:hover {
            background-color: #1D4ED8;
            transform: translateY(-2px);
        }
        .ai-chat-modal {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 400px;
            height: 500px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .ai-chat-modal.show {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }
        .ai-chat-header {
            padding: 15px;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-chat-header h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        .ai-chat-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        .ai-chat-history {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }
        .chat-bubble.user {
            background-color: #2563eb;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.ai {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-bubble.loading {
            align-self: flex-start;
            color: #6b7280;
        }
        .ai-chat-input-area {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        .ai-chat-input-area input {
            flex-grow: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 8px;
                overflow: hidden;
                transition: border-color 0.3s;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right; /* Default for most td in responsive view */
                font-size: 14px;
            }
            td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #4b5563;
                transition: color 0.3s;
            }
            td:nth-of-type(1):before { content: "Task Name:"; }
            td:nth-of-type(2):before { content: "Description:"; }
            td:nth-of-type(3):before { content: "OT/DT Multiplier:"; }
            td:nth-of-type(4):before { content: "Trade:"; }
            td:nth-of-type(5):before { content: "Skill:"; }
            td:nth-of-type(6):before { content: "Rate:"; }
            td:nth-of-type(7):before { content: "# hrs:"; }
            td:nth-of-type(8):before { content: "Labor Total:"; }
            td:nth-of-type(9):before { content: "QTY / UNIT:"; }
            td:nth-of-type(10):before { content: "$ / UNIT:"; }
            td:nth-of-type(11):before { content: "Materials Total:"; }
            td:nth-of-type(12):before { content: "Equipment / Rental:"; }
            td:nth-of-type(13):before { content: "Subcontractor:"; }
            td:nth-of-type(14):before { content: "Misc.:"; }
            td:nth-of-type(15):before { content: "Other Total:"; }
            td:nth-of-type(16):before { content: "TOTAL:"; }
            td:nth-of-type(17):before { content: "Actions:"; }
        }

        @media (max-width: 768px) {
            .card, .wizard-content {
                padding: 20px;
                margin-bottom: 15px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        /* Hide spinner arrows for number input fields */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Dark Theme Styles */
        body.dark-theme {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        .dark-theme .card {
            background: #2d3748;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }
        .dark-theme .input-field {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .dark-theme .input-field:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
        }
        .dark-theme .label,
        .dark-theme h1, .dark-theme h2, .dark-theme h3, .dark-theme h4 {
            color: #e2e8f0;
        }
        .dark-theme td:before {
            color: #a0aec0;
        }
        .dark-theme table, .dark-theme th, .dark-theme td {
            border-color: #4a5568;
        }
        .dark-theme th {
            background: #4a5568;
            color: #e2e8f0;
        }
        .dark-theme tr:nth-child(even) {
            background: #2d3748;
        }
        .dark-theme tr:hover {
            background: #4a5568;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Entry Point Screen -->
    <div id="entryPointContainer" class="entry-point-container">
        <div class="entry-point-content">
            <h1>Construction Estimator Pro</h1>
            <p>Choose how you'd like to begin.</p>
            <div class="entry-point-buttons">
                <button id="startDetailedBtn" class="btn btn-primary">Start Detailed Estimate</button>
                <button id="startQuickQuoteBtn" class="btn btn-green">Generate Quick Quote</button>
            </div>
        </div>
    </div>

    <!-- Main App for Detailed Estimate -->
    <div id="mainApp" class="container hidden">
        <div id="appHeaderPlaceholder"></div>
        <div id="summaryOverviewPlaceholder"></div>
        <div id="estimateLineItemsTableContainer"></div>
    </div>

    <!-- App for Quick Quote -->
    <div id="quickQuoteApp" class="container hidden">
        <div id="appHeaderPlaceholderQuickQuote"></div>
        <div id="quickQuoteSummaryPlaceholder"></div>
    </div>

    <!-- Placeholders for Modals -->
    <div id="setupWizardPlaceholder"></div>
    <div id="savedProjectsPlaceholder"></div>
    <div id="saveProjectModalContainer"></div>
    <div id="aiChatModalContainer"></div>

    <script>
        // --- Global State ---
        let projectSettings = {};
        let estimateItems = [];
        let currentAppMode = 'entry'; // 'entry', 'detailed', 'quickQuote'
        let isDarkTheme = false;
        const stateSalesTax = { 'CA': 8.25, 'TX': 6.25, 'NY': 4.0, 'FL': 6.0, 'WA': 6.5, 'IL': 6.25, 'AL': 4.0, 'AK': 0.0, 'AZ': 5.6, 'AR': 6.5, 'CO': 2.9, 'CT': 6.35, 'DE': 0.0, 'GA': 4.0, 'HI': 4.0, 'ID': 6.0, 'IN': 7.0, 'IA': 6.0, 'KS': 6.5, 'KY': 6.0, 'LA': 4.45, 'ME': 5.5, 'MD': 6.0, 'MA': 6.25, 'MI': 6.0, 'MN': 6.875, 'MS': 7.0, 'MO': 4.225, 'MT': 0.0, 'NE': 5.5, 'NV': 6.85, 'NH': 0.0, 'NJ': 6.625, 'NM': 5.125, 'NC': 4.75, 'ND': 5.0, 'OH': 5.75, 'OK': 4.5, 'OR': 0.0, 'PA': 6.0, 'RI': 7.0, 'SC': 6.0, 'SD': 4.5, 'TN': 7.0, 'UT': 4.85, 'VT': 6.0, 'VA': 5.3, 'WV': 6.0, 'WI': 5.0, 'WY': 4.0 };
        const initialProjectSettings = JSON.parse(JSON.stringify({ projectName: "New Project", clientName: "", projectType: "Commercial", projectState: "CA", profitMargin: 15, salesTax: 0, miscellaneous: 5, overhead: 10, materialMarkup: 10, activeTrades: ["General"], allTradeLaborRates: { "General": { "Project Manager": 120, "Superintendent": 100, "General Foreman": 90, "Foreman": 85, "Journeyman": 75, "Apprentice": 50 }, "Electrical": { "Project Manager": 135, "Superintendent": 110, "General Foreman": 100, "Foreman": 95, "Journeyman": 80, "Apprentice": 55 }, "Plumbing": { "Project Manager": 125, "Superintendent": 105, "General Foreman": 95, "Foreman": 90, "Journeyman": 78, "Apprentice": 52 } } }));
        const initialEstimateItems = JSON.parse(JSON.stringify([{ id: Date.now(), taskName: 'Initial Task', description: '', trade: 'General', rateRole: 'Journeyman', hours: 0, otDtMultiplier: 1.0, materialQuantity: 0, materialUnitCost: 0, equipmentRentalCost: 0, subcontractorCostLineItem: 0, miscLineItem: 0 }]));

        // --- UI Element References ---
        const entryPointContainer = document.getElementById('entryPointContainer');
        const mainApp = document.getElementById('mainApp');
        const quickQuoteApp = document.getElementById('quickQuoteApp');
        const setupWizardPlaceholder = document.getElementById('setupWizardPlaceholder');
        const savedProjectsPlaceholder = document.getElementById('savedProjectsPlaceholder');

        // --- View Manager ---
        function showView(viewName) {
            entryPointContainer.classList.add('hidden');
            mainApp.classList.add('hidden');
            quickQuoteApp.classList.add('hidden');
            setupWizardPlaceholder.classList.add('hidden');
            savedProjectsPlaceholder.classList.add('hidden');

            if (viewName === 'entry') entryPointContainer.classList.remove('hidden');
            else if (viewName === 'detailed') mainApp.classList.remove('hidden');
            else if (viewName === 'quickQuote') quickQuoteApp.classList.remove('hidden');
            else if (viewName === 'wizard') setupWizardPlaceholder.classList.remove('hidden');
            else if (viewName === 'savedProjects') savedProjectsPlaceholder.classList.remove('hidden');
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            resetProjectData();
            loadAppHeader();
            
            document.getElementById('startDetailedBtn').addEventListener('click', startDetailedEstimate);
            document.getElementById('startQuickQuoteBtn').addEventListener('click', startQuickQuote);
        });

        function resetProjectData() {
            projectSettings = JSON.parse(JSON.stringify(initialProjectSettings));
            estimateItems = JSON.parse(JSON.stringify(initialEstimateItems));
        }

        // --- Flow Control Functions ---
        function startDetailedEstimate() {
            currentAppMode = 'detailed';
            showView('wizard');
            loadSetupWizard();
        }

        function startQuickQuote() {
            currentAppMode = 'quickQuote';
            showView('quickQuote');
            loadQuickQuoteSummary();
        }

        function handleWizardCompletion(updatedSettings) {
            projectSettings = { ...updatedSettings };
            showView('detailed');
            loadDetailedDashboard();
        }

        function reconfigureApp() {
            renderMessageBox("This will reset everything and return to the main screen. Are you sure?", () => {
                resetProjectData();
                showView('entry');
                closeMessageBox();
            }, true);
        }
        
        // --- Component Loaders ---
        async function loadComponent(path, placeholderId, jsInitFunction) {
            try {
                const htmlResponse = await fetch(`${path}.html`);
                if (!htmlResponse.ok) throw new Error(`Failed to load HTML for ${path}`);
                document.getElementById(placeholderId).innerHTML = await htmlResponse.text();

                if (jsInitFunction) {
                    const script = document.createElement('script');
                    script.src = `${path}.js`;
                    script.onload = jsInitFunction;
                    document.body.appendChild(script);
                }
            } catch (error) {
                console.error(`Error loading component ${path}:`, error);
            }
        }

        function loadAppHeader() {
            loadComponent('src/components/AppHeader/AppHeader', 'appHeaderPlaceholder', () => {
                if(window.AppHeader) {
                    window.AppHeader.init({ onReconfigure: reconfigureApp, onUserProfileClick: () => { showView('savedProjects'); loadSavedProjects(); }});
                }
            });
            loadComponent('src/components/AppHeader/AppHeader', 'appHeaderPlaceholderQuickQuote');
        }

        function loadSetupWizard() {
            loadComponent('src/sections/SetupWizard/SetupWizard', 'setupWizardPlaceholder', () => {
                if(window.SetupWizard) {
                    window.SetupWizard.init({ projectSettings, estimateItems, stateSalesTax, onCompletion: handleWizardCompletion, renderMessageBox, closeMessageBox });
                }
            });
        }
        
        function loadQuickQuoteSummary() {
            loadComponent('src/sections/QuickQuoteSummary/QuickQuoteSummary', 'quickQuoteSummaryPlaceholder', () => {
                if(window.QuickQuoteSummary) {
                    window.QuickQuoteSummary.init({ projectSettings, formatCurrency, formatHours });
                }
            });
        }
        
        function loadDetailedDashboard() {
            // This function is now responsible for loading all parts of the detailed view
            // This is where you would load the original detailed summary and line items table.
            // For now, we'll just re-create the original structure dynamically.
            const summaryPlaceholder = document.getElementById('summaryOverviewPlaceholder');
            const tablePlaceholder = document.getElementById('estimateLineItemsTableContainer');
            
            // This is a simplified representation of your original detailed dashboard structure
            summaryPlaceholder.innerHTML = `<!-- Your original SummaryOverview.html content would go here -->`;
            tablePlaceholder.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold">Estimate Line Items</h3>
                    <button id="addItemBtn" class="btn btn-green">âž• Add Item</button>
                </div>
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th rowspan="2">Task Name</th>
                            <th rowspan="2">Description</th>
                            <th colspan="5" class="text-center">LABOR</th>
                            <th colspan="3" class="text-center">MATERIALS</th>
                            <th colspan="4" class="text-center">OTHER</th>
                            <th rowspan="2">TOTAL</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr>
                            <th>OT/DT</th>
                            <th>Trade</th>
                            <th>Skill</th>
                            <th>$/hr</th>
                            <th>Labor Total</th>
                            <th>QTY / UNIT</th>
                            <th>$ / UNIT</th>
                            <th>Materials Total</th>
                            <th>Equipment</th>
                            <th>Sub</th>
                            <th>Misc.</th>
                            <th>Other Total</th>
                        </tr>
                    </thead>
                    <tbody id="estimateTableBody"></tbody>
                </table>`;
            
            // Re-initialize event listeners for the detailed view
            document.getElementById('addItemBtn').addEventListener('click', () => addItem('detailed'));
            // ... and so on for other detailed view functionality
            renderItems(); // Render the initial items for the detailed view
        }

        function loadSavedProjects() {
            loadComponent('src/sections/SavedProjects/SavedProjects', 'savedProjectsPlaceholder', () => {
                if(window.SavedProjects) { window.SavedProjects.init({ /* config */ }); }
            });
        }

        // --- Utility & Calculation Functions ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        function formatHours(hours) {
            return parseFloat(hours || 0).toFixed(2);
        }
        function renderMessageBox(message, onConfirmCallback = null, isConfirm = false) {
            const existingOverlay = document.getElementById('messageBoxOverlay');
            if (existingOverlay) existingOverlay.remove();
            const overlay = document.createElement('div');
            overlay.id = 'messageBoxOverlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[2001]';
            const box = document.createElement('div');
            box.className = 'bg-white rounded-xl p-8 shadow-2xl max-w-sm mx-auto text-center';
            let buttonsHtml = `<button class="btn btn-primary" onclick="closeMessageBox()">OK</button>`;
            if (isConfirm) {
                buttonsHtml = `<button class="btn btn-red mr-3" id="confirmYesBtn">Yes</button><button class="btn btn-primary" onclick="closeMessageBox()">No</button>`;
            }
            box.innerHTML = `<p class="text-lg font-semibold text-gray-800 mb-6">${message}</p><div class="flex justify-center gap-3">${buttonsHtml}</div>`;
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            if (isConfirm && onConfirmCallback) {
                document.getElementById('confirmYesBtn').addEventListener('click', onConfirmCallback);
            }
        }
        function closeMessageBox() {
            const overlay = document.getElementById('messageBoxOverlay');
            if (overlay) overlay.remove();
        }

        // This is a simplified renderItems for the detailed view, you would replace this
        // with your original, more complex renderItems function.
        function renderItems() {
             const tableBody = document.getElementById('estimateTableBody');
             if(!tableBody) return;
             tableBody.innerHTML = '';
             // Logic to render detailed items would go here...
             console.log("Rendering detailed estimate items...");
        }

    </script>
</body>
</html>
